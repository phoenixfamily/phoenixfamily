<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webmail Inbox</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            overflow: hidden;
        }

        .sidebar {
            height: 100vh;
        }

        .chat-list .list-group-item {
            border: none;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
            cursor: pointer;
        }

        .chat-list .list-group-item:hover {
            background: #f1f5ff;
        }

        .chat-list .unread .fw-bold {
            color: #0d6efd;
        }

        .chat-list img {
            width: 45px;
            height: 45px;
            object-fit: cover;
        }

        .email-view {
            height: 100vh;
            overflow-y: auto;
        }

        .email-header {
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">

        <!-- Sidebar -->
        <div class="col-2 bg-light border-end sidebar p-3">
            <h4 class="mb-4">PhoenixMail</h4>
            <button id="compose-btn" class="btn btn-primary w-100 mb-4">+ Compose</button>
            <ul class="list-group">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Inbox <span id="unread-count" class="badge bg-danger">{{ emails|length }}</span>
                </li>
                <li class="list-group-item">Sent</li>
                <li class="list-group-item">Drafts</li>
                <li class="list-group-item">Spam</li>
                <li class="list-group-item">Trash</li>
            </ul>
        </div>

        <!-- Email List -->
        <div class="col-3 p-0 border-end chat-list">
            <div class="list-group list-group-flush" id="email-list"></div>
        </div>


        <!-- Email View -->
        <div class="col-7 email-view p-4" id="email-view">
            <p class="text-muted">Select an email to read</p>
        </div>

    </div>
</div>

<!-- Compose Modal -->
<div class="modal fade" id="composeModal" tabindex="-1" aria-labelledby="composeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="composeModalLabel">Compose Email</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="composeForm">
                    <div class="mb-3">
                        <label for="toEmail" class="form-label">To</label>
                        <input type="email" class="form-control" id="toEmail" placeholder="recipient@example.com"
                               required>
                    </div>
                    <div class="mb-3">
                        <label for="subject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="subject" placeholder="Subject" required>
                    </div>
                    <div class="mb-3">
                        <label for="body" class="form-label">Body</label>
                        <textarea class="form-control" id="body" rows="8" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Send</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    /* helper: get CSRF token from cookie (Django) */
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    /* Compose modal send */
    document.getElementById("composeForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const to = document.getElementById("toEmail").value;
        const subject = document.getElementById("subject").value;
        const body = document.getElementById("body").value;

        fetch("{% url 'webmail:send_mail' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken,
                "Accept": "application/json",
            },
            body: JSON.stringify({to_email: to, subject: subject, body: body})
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    alert("Email sent successfully!");
                    composeModal.hide();
                    loadInbox(); // refresh inbox
                } else {
                    alert("Error sending email: " + (data.message || JSON.stringify(data)));
                }
            })
            .catch(err => {
                console.error(err);
                alert("Network error while sending email.");
            });
    });

    /* Load inbox (JSON) */
    function loadInbox() {
        fetch("{% url 'webmail:inbox_api' %}", {
            method: "GET",
            headers: {"Accept": "application/json"}
        })
            .then(res => {
                if (!res.ok) throw res;
                return res.json();
            })
            .then(data => {
                if (data.status !== "success") {
                    console.error("inbox error:", data);
                    return;
                }
                const list = document.getElementById("email-list");
                list.innerHTML = "";
                data.emails.forEach(email => {
                    const item = document.createElement("a");
                    item.className = "list-group-item list-group-item-action d-flex align-items-start";
                    item.href = "javascript:void(0);";
                    item.dataset.uid = email.uid;
                    item.innerHTML = `
                <div class="flex-fill">
                    <div class="fw-bold">${escapeHtml(email.from || "")}</div>
                    <div class="text-truncate">${escapeHtml(email.subject || "(No subject)")}</div>
                </div>
                <small class="text-muted">${escapeHtml(email.date || "")}</small>
            `;
                    item.addEventListener("click", () => loadEmail(email.uid));
                    list.appendChild(item);
                });
                // update unread counter (or total)
                const unreadCountEl = document.getElementById("unread-count");
                if (unreadCountEl) unreadCountEl.textContent = data.emails.length;
            })
            .catch(async err => {
                console.error("Failed to load inbox", err);
                try {
                    const txt = await err.json();
                    console.error(txt);
                } catch (e) {
                }
            });
    }

    /* Load single email by UID */
    function loadEmail(uid) {
        fetch("{% url 'webmail:fetch_email' uid='__UID__' %}".replace("__UID__", encodeURIComponent(uid)), {
            method: "GET",
            headers: {"Accept": "application/json"}
        })
            .then(res => {
                if (!res.ok) throw res;
                return res.json();
            })
            .then(data => {
                if (data.status !== "success") {
                    console.error("fetch email error", data);
                    return;
                }
                const view = document.getElementById("email-view");
                view.innerHTML = `
            <div class="email-header">
                <h5>${escapeHtml(data.email.subject || "(No subject)")}</h5>
                <p class="text-muted">From: ${escapeHtml(data.email.from || "")}</p>
                <p class="text-muted">To: ${escapeHtml(data.email.to || "")}</p>
                <p class="text-muted small">${escapeHtml(data.email.date || "")}</p>
            </div>
            <div>${data.email.body_html ? data.email.body_html : "<pre>" + escapeHtml(data.email.body || "") + "</pre>"}</div>
        `;
            })
            .catch(async err => {
                console.error("Failed to load email", err);
            });
    }

    /* simple HTML escape */
    function escapeHtml(unsafe) {
        if (unsafe == null) return "";
        return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    /* Init */
    document.addEventListener("DOMContentLoaded", loadInbox);
</script>

</body>
</html>
